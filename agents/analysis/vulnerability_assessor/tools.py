from __future__ import annotations

from typing import Any, Dict, List

from agents.perception.scope_scanner.sensors import collect_scope_targets
from shared.tools.security_tools import run_security_scan


def run_scope_security_sweep(max_targets: int = 12) -> Dict[str, Any]:
    """
    Discover assets first, then run best-effort security scans on a bounded target set.
    """
    scope = collect_scope_targets(max_assets=400)
    assets = scope.get("assets", []) if isinstance(scope, dict) else []
    bounded = max(1, min(max_targets, 50))

    candidate_targets: List[str] = []
    for asset in assets:
        if not isinstance(asset, dict):
            continue
        ip_address = str(asset.get("ip_address", "")).strip()
        hostname = str(asset.get("hostname", "")).strip()
        asset_name = str(asset.get("asset_name", "")).strip()

        for candidate in (ip_address, hostname, asset_name):
            if not candidate or candidate in candidate_targets:
                continue
            candidate_targets.append(candidate)
            break

        if len(candidate_targets) >= bounded:
            break

    if not candidate_targets:
        candidate_targets = ["localhost"]

    scan_results = []
    for target in candidate_targets:
        try:
            scan_results.append(run_security_scan(target))
        except Exception as exc:  # Defensive: keep sweep non-blocking.
            scan_results.append(
                {
                    "target": target,
                    "findings": [],
                    "summary": {"total_findings": 0},
                    "notes": [f"security scan failed for target: {exc}"],
                }
            )

    total_findings = sum(
        int(result.get("summary", {}).get("total_findings", 0))
        for result in scan_results
        if isinstance(result, dict)
    )

    return {
        "scope_summary": scope.get("summary", {}) if isinstance(scope, dict) else {},
        "targets_scanned": candidate_targets,
        "total_targets_scanned": len(candidate_targets),
        "total_findings": total_findings,
        "scan_results": scan_results,
        "note": "Security sweep is best-effort and will return partial results when some scanners are unavailable.",
    }


TOOLS = [run_security_scan, run_scope_security_sweep, collect_scope_targets]
